<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Miner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: #0f0f13; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin: 0; padding: 20px; }
        .card { background: #1e1e24; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        h1, h2 { margin: 0; }
        .balance { font-size: 32px; color: #f1c40f; font-weight: bold; margin: 10px 0; }
        .sub-balance { font-size: 16px; color: #2ecc71; }
        
        .miner-circle {
            width: 180px; height: 180px; margin: 20px auto;
            border-radius: 50%; border: 5px solid #333;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle, #2c3e50, #000);
            box-shadow: 0 0 20px #f39c12;
            transition: all 0.3s;
        }
        .miner-circle.active { box-shadow: 0 0 40px #2ecc71; border-color: #2ecc71; }
        
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-start { background: #f39c12; color: #000; }
        .btn-claim { background: #2ecc71; color: white; display: none; }
        .btn-action { background: #3498db; color: white; margin-bottom: 5px;}
        
        input { width: 90%; padding: 12px; border-radius: 8px; border: none; background: #333; color: white; margin-bottom: 10px; text-align: center;}
    </style>
</head>
<body>

    <div class="card">
        <div class="balance"><span id="donBal">0.000000</span> DON</div>
        <div class="sub-balance">â‰ˆ <span id="usdtBal">0.00</span> USDT</div>
    </div>

    <div class="miner-circle" id="minerCircle">
        <h2 id="timer">00:00:00</h2>
        <span id="statusText" style="font-size: 12px; color: #aaa;">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡</span>
    </div>
    
    <button class="btn-start" id="startBtn" onclick="startMining()">â›ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ† (3 Ø³Ø§Ø¹Ø§Øª)</button>
    <button class="btn-claim" id="claimBtn" onclick="claimRewards()">ğŸ’° Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</button>

    <div class="card" style="margin-top: 20px;">
        <h3>Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
        <button class="btn-action" onclick="exchange()">ğŸ’± ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙ„ Ù„Ù€ USDT</button>
        <div style="margin-top: 15px;">
            <input type="text" id="walletAddr" placeholder="Ø¹Ù†ÙˆØ§Ù† FaucetPay USDT">
            <button class="btn-action" style="background:#e74c3c" onclick="withdraw()">ğŸ“¤ Ø³Ø­Ø¨ Ù„Ù„Ø£Ø±Ø¨Ø§Ø­</button>
        </div>
        <p id="msg" style="font-size: 12px; color: yellow;"></p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "test_user_1"; 
        
        // Ø§Ø³ØªØ®Ø±Ø¬ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø¯Ø¡ (start param)
        const startParam = tg.initDataUnsafe.start_param;

        // ** Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹ **
        const SERVER_URL = "https://your-app.onrender.com"; 

        let miningInterval;

        // 1. ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        async function loadData() {
            try {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ©ØŒ Ø£Ø±Ø³Ù„Ù‡ Ø£ÙˆÙ„Ø§Ù‹
                if(startParam) {
                    await fetch(`${SERVER_URL}/set-referrer`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id: userId, ref_id: startParam })
                    });
                }

                const res = await fetch(`${SERVER_URL}/user/${userId}`);
                const data = await res.json();
                
                updateUI(data);
            } catch (e) { console.error(e); }
        }

        function updateUI(data) {
            document.getElementById('donBal').innerText = parseFloat(data.balance_don).toFixed(6);
            document.getElementById('usdtBal').innerText = parseFloat(data.balance_usdt).toFixed(4);

            const timer = document.getElementById('timer');
            const circle = document.getElementById('minerCircle');
            const startBtn = document.getElementById('startBtn');
            const claimBtn = document.getElementById('claimBtn');
            const statusText = document.getElementById('statusText');

            if (data.is_mining) {
                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ† ÙŠØ¹Ù…Ù„
                circle.classList.add('active');
                startBtn.style.display = 'none';
                claimBtn.style.display = 'none';
                statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ†...";
                startTimer(data.remaining_seconds);
            } else if (data.remaining_seconds === 0 && data.pending_don > 0) {
                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø§Ù†ØªÙ‡Ù‰ ÙˆÙŠÙˆØ¬Ø¯ Ø£Ø±Ø¨Ø§Ø­
                circle.classList.remove('active');
                startBtn.style.display = 'none';
                claimBtn.style.display = 'block';
                timer.innerText = "Ù…ÙƒØªÙ…Ù„!";
                statusText.innerText = "Ø§Ø¶ØºØ· Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­";
            } else {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ†
                circle.classList.remove('active');
                startBtn.style.display = 'block';
                claimBtn.style.display = 'none';
                timer.innerText = "00:00:00";
                statusText.innerText = "Ø®Ø§Ù…Ù„";
                clearInterval(miningInterval);
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
        function startTimer(seconds) {
            clearInterval(miningInterval);
            let remaining = Math.floor(seconds);
            
            miningInterval = setInterval(() => {
                remaining--;
                if (remaining <= 0) {
                    clearInterval(miningInterval);
                    loadData(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¬Ù…Ø¹
                    return;
                }
                
                const h = Math.floor(remaining / 3600).toString().padStart(2, '0');
                const m = Math.floor((remaining % 3600) / 60).toString().padStart(2, '0');
                const s = (remaining % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        async function startMining() {
            await fetch(`${SERVER_URL}/start-mining`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: userId })
            });
            loadData();
        }

        async function claimRewards() {
            await fetch(`${SERVER_URL}/claim`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: userId })
            });
            loadData();
        }

        async function exchange() {
            const res = await fetch(`${SERVER_URL}/exchange`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: userId })
            });
            const data = await res.json();
            alert(data.message);
            loadData();
        }

        async function withdraw() {
            const addr = document.getElementById('walletAddr').value;
            const msg = document.getElementById('msg');
            msg.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...";
            
            const res = await fetch(`${SERVER_URL}/withdraw`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: userId, address: addr })
            });
            const data = await res.json();
            msg.innerText = data.message;
            if(data.success) {
                msg.style.color = "green";
                loadData();
            } else {
                msg.style.color = "red";
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        loadData();
    </script>
</body>
</html>

